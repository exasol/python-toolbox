name: 'SIA'
description: 'The Security Issues Action creates github issues for open security issues in the repository'

# TODOs & Ideas
# * Change format to official CVE schema
# * Change action to support all kinds of formats
# * Add custom/additional details on ticket creation (e.g. dependency tree)

inputs:

  scan-command:
    description: 'Command which creates a security report for the repository'
    required: true
    default: "mvn org.sonatype.ossindex.maven:ossindex-maven-plugin:audit org.sonatype.ossindex.maven:ossindex-maven-plugin:audit-aggregate -Dossindex.reportFile=security-issues.json"

  scan-output:
    description: 'Output file generated by the scan-command'
    required: true
    default: "security-issues.json"

  input-converter:
    description: 'Converter to apply on the scan-output before processing'
    required: false
    # passthrough in case of None
    default: maven

runs:

  using: "composite"
  steps:

    - name: Setup Python (${{ inputs.python-version}})
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.python-version }}

    # Pin this to specifically released verison
    - name: Install Python Toolbox / Security tool
      run: |
        pip install 'git+https://github.com/exasol/python-toolbox.git@security-issues-action'

    - name: Install Python Toolbox / Security Issues tool
      run: |
        scan-command > $scan-output

    - name: Run scan-command
      run: |
        scan-command > $scan-output

    - name: Run input-converter
      run: |
        security-issues convert maven < $scan-output > issues.json

    - name: Filter Existing Issues (Open & Closed)
      run: |
        security-issues filter github < scan.json > issues.json
      # This could be added in the future
      # tbx security-issues filter exclusions < issues.json > filtered-pt2.json

    - name: Create Issues for
      run: |
        security-issues create github < issues.json
